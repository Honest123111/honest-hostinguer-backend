runtime: python
pythonVersion: "3.11"

build:
  # Add logs bucket configuration
  options:
    logging: CLOUD_LOGGING_ONLY
    default_logs_bucket_behavior: REGIONAL_USER_OWNED_BUCKET
  steps:
    - name: "Create directories"
      entrypoint: bash
      args:
        - -c
        - "mkdir -p static staticfiles templates media"
    - name: "Install frontend dependencies"
      entrypoint: bash
      args:
        - -c
        - "cd honest-angular && npm install || echo 'No Angular app found, skipping'"
    - name: "Build Angular frontend"
      entrypoint: bash
      args:
        - -c
        - "cd honest-angular && npm run build || echo 'No Angular app found, skipping'"
    - name: "Copy frontend to Django static folder"
      entrypoint: bash
      args:
        - -c
        - "mkdir -p staticfiles && cp -r honest-angular/dist/honest-angular/browser/* staticfiles/ || echo 'No Angular build found, skipping'"
    - name: "Install Python dependencies"
      entrypoint: bash
      args:
        - -c
        - "pip install -r requirements.txt"
    - name: "Collect Django static files"
      entrypoint: bash
      args:
        - -c
        - "python manage.py collectstatic --noinput"

env:
  - variable: "DEBUG"
    value: "False"
  - variable: "ALLOWED_HOSTS"
    value: "*,honest-hostinguer-backend--honesttransportationfron-21ca5.us-central1.hosted.app"
  - variable: "SECRET_KEY"
    value: "firebase-app-hosting-secure-key-production"
  - variable: "EMAIL_HOST_USER"
    value: "noreply@example.com"
  - variable: "EMAIL_HOST_PASSWORD"
    value: "dummy-password"
  - variable: "FRONTEND_RESET_URL"
    value: "https://honesttransportationfron-21ca5.web.app/forgot-password"

runConfig:
  entrypoint: bash
  args:
    - -c
    - "gunicorn honestdb_project.wsgi:application --bind 0.0.0.0:8080"
